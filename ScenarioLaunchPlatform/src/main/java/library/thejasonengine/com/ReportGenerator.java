/*  Report Generator
*
*	Author(s): Jason Flood/John Clarke
*  	Licence: Apache 2
*  
*/

package library.thejasonengine.com;

import io.vertx.core.json.JsonObject;
import io.vertx.core.json.JsonArray;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * Generates security test reports from pattern execution records
 */
public class ReportGenerator {
    
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    private static final DateTimeFormatter FILE_DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss");
    
    /**
     * Generate HTML report from execution records
     */
    public static String generateHtmlReport(List<PatternExecutionRecord> records, String reportTitle) {
        StringBuilder html = new StringBuilder();
        
        html.append("<!DOCTYPE html>\n");
        html.append("<html>\n<head>\n");
        html.append("<title>").append(reportTitle).append("</title>\n");
        html.append("<meta charset=\"UTF-8\">\n");
        html.append("<style>\n");
        html.append(getReportStyles());
        html.append("</style>\n");
        html.append("</head>\n<body>\n");
        
        // Header
        html.append("<div class=\"header\">\n");
        html.append("<h1>").append(reportTitle).append("</h1>\n");
        html.append("<p class=\"subtitle\">Generated: ").append(LocalDateTime.now().format(DATE_FORMATTER)).append("</p>\n");
        html.append("</div>\n");
        
        // Executive Summary
        html.append(generateExecutiveSummary(records));
        
        // Statistics
        html.append(generateStatistics(records));
        
        // Detailed Results
        html.append(generateDetailedResults(records));
        
        // Recommendations
        html.append(generateRecommendations(records));
        
        // Footer
        html.append("<div class=\"footer\">\n");
        html.append("<p>Report generated by ScenarioLaunchPlatform Attack Pattern Library</p>\n");
        html.append("</div>\n");
        
        html.append("</body>\n</html>");
        
        return html.toString();
    }
    
    /**
     * Generate JSON report
     */
    public static JsonObject generateJsonReport(List<PatternExecutionRecord> records, String reportTitle) {
        JsonObject report = new JsonObject();
        
        report.put("title", reportTitle);
        report.put("generatedAt", LocalDateTime.now().format(DATE_FORMATTER));
        report.put("totalExecutions", records.size());
        
        // Summary statistics
        JsonObject summary = new JsonObject();
        summary.put("totalPatterns", records.stream().map(PatternExecutionRecord::getPatternId).distinct().count());
        summary.put("totalQueries", records.stream().mapToInt(PatternExecutionRecord::getTotalQueries).sum());
        summary.put("successfulQueries", records.stream().mapToInt(PatternExecutionRecord::getSuccessfulQueries).sum());
        summary.put("failedQueries", records.stream().mapToInt(PatternExecutionRecord::getFailedQueries).sum());
        summary.put("totalDurationMs", records.stream().mapToLong(PatternExecutionRecord::getExecutionDurationMs).sum());
        summary.put("guardiumAlertsExpected", records.size());
        summary.put("guardiumAlertsDetected", records.stream().filter(PatternExecutionRecord::isGuardiumAlertDetected).count());
        report.put("summary", summary);
        
        // Category breakdown
        Map<String, Long> categoryBreakdown = records.stream()
            .collect(Collectors.groupingBy(PatternExecutionRecord::getCategory, Collectors.counting()));
        JsonObject categoryJson = new JsonObject();
        categoryBreakdown.forEach((k, v) -> categoryJson.put(k, v));
        report.put("categoryBreakdown", categoryJson);
        
        // Severity breakdown
        Map<String, Long> severityBreakdown = records.stream()
            .collect(Collectors.groupingBy(PatternExecutionRecord::getSeverity, Collectors.counting()));
        JsonObject severityJson = new JsonObject();
        severityBreakdown.forEach((k, v) -> severityJson.put(k, v));
        report.put("severityBreakdown", severityJson);
        
        // Execution records
        JsonArray executionsArray = new JsonArray();
        records.forEach(record -> executionsArray.add(record.toJson()));
        report.put("executions", executionsArray);
        
        return report;
    }
    
    /**
     * Generate CSV report
     */
    public static String generateCsvReport(List<PatternExecutionRecord> records) {
        StringBuilder csv = new StringBuilder();
        
        // Header
        csv.append("Execution ID,Pattern ID,Pattern Name,Category,Severity,Target Database,Database Type,");
        csv.append("Execution Time,Executed By,Total Queries,Successful,Failed,Duration (ms),");
        csv.append("Guardium Alert Expected,Guardium Alert Detected,Notes\n");
        
        // Data rows
        for (PatternExecutionRecord record : records) {
            csv.append(escapeCsv(record.getExecutionId())).append(",");
            csv.append(escapeCsv(record.getPatternId())).append(",");
            csv.append(escapeCsv(record.getPatternName())).append(",");
            csv.append(escapeCsv(record.getCategory())).append(",");
            csv.append(escapeCsv(record.getSeverity())).append(",");
            csv.append(escapeCsv(record.getTargetDatabase())).append(",");
            csv.append(escapeCsv(record.getDatabaseType())).append(",");
            csv.append(escapeCsv(record.getExecutionTime().format(DATE_FORMATTER))).append(",");
            csv.append(escapeCsv(record.getExecutedBy())).append(",");
            csv.append(record.getTotalQueries()).append(",");
            csv.append(record.getSuccessfulQueries()).append(",");
            csv.append(record.getFailedQueries()).append(",");
            csv.append(record.getExecutionDurationMs()).append(",");
            csv.append(escapeCsv(record.getGuardiumAlertExpected())).append(",");
            csv.append(record.isGuardiumAlertDetected()).append(",");
            csv.append(escapeCsv(record.getNotes())).append("\n");
        }
        
        return csv.toString();
    }
    
    private static String generateExecutiveSummary(List<PatternExecutionRecord> records) {
        StringBuilder html = new StringBuilder();
        
        int totalExecutions = records.size();
        int totalQueries = records.stream().mapToInt(PatternExecutionRecord::getTotalQueries).sum();
        int successfulQueries = records.stream().mapToInt(PatternExecutionRecord::getSuccessfulQueries).sum();
        int failedQueries = records.stream().mapToInt(PatternExecutionRecord::getFailedQueries).sum();
        double successRate = totalQueries > 0 ? (successfulQueries * 100.0 / totalQueries) : 0;
        
        html.append("<div class=\"section\">\n");
        html.append("<h2>Executive Summary</h2>\n");
        html.append("<div class=\"summary-grid\">\n");
        html.append("<div class=\"summary-card\">\n");
        html.append("<h3>").append(totalExecutions).append("</h3>\n");
        html.append("<p>Pattern Executions</p>\n");
        html.append("</div>\n");
        html.append("<div class=\"summary-card\">\n");
        html.append("<h3>").append(totalQueries).append("</h3>\n");
        html.append("<p>Total Queries</p>\n");
        html.append("</div>\n");
        html.append("<div class=\"summary-card success\">\n");
        html.append("<h3>").append(successfulQueries).append("</h3>\n");
        html.append("<p>Successful</p>\n");
        html.append("</div>\n");
        html.append("<div class=\"summary-card error\">\n");
        html.append("<h3>").append(failedQueries).append("</h3>\n");
        html.append("<p>Failed</p>\n");
        html.append("</div>\n");
        html.append("<div class=\"summary-card\">\n");
        html.append("<h3>").append(String.format("%.1f%%", successRate)).append("</h3>\n");
        html.append("<p>Success Rate</p>\n");
        html.append("</div>\n");
        html.append("</div>\n");
        html.append("</div>\n");
        
        return html.toString();
    }
    
    private static String generateStatistics(List<PatternExecutionRecord> records) {
        StringBuilder html = new StringBuilder();
        
        Map<String, Long> categoryBreakdown = records.stream()
            .collect(Collectors.groupingBy(PatternExecutionRecord::getCategory, Collectors.counting()));
        
        Map<String, Long> severityBreakdown = records.stream()
            .collect(Collectors.groupingBy(PatternExecutionRecord::getSeverity, Collectors.counting()));
        
        html.append("<div class=\"section\">\n");
        html.append("<h2>Statistics</h2>\n");
        html.append("<div class=\"stats-grid\">\n");
        
        // Category breakdown
        html.append("<div class=\"stats-card\">\n");
        html.append("<h3>By Category</h3>\n");
        html.append("<table>\n");
        categoryBreakdown.forEach((category, count) -> {
            html.append("<tr><td>").append(category).append("</td><td>").append(count).append("</td></tr>\n");
        });
        html.append("</table>\n");
        html.append("</div>\n");
        
        // Severity breakdown
        html.append("<div class=\"stats-card\">\n");
        html.append("<h3>By Severity</h3>\n");
        html.append("<table>\n");
        severityBreakdown.forEach((severity, count) -> {
            String cssClass = severity.toLowerCase();
            html.append("<tr><td><span class=\"badge badge-").append(cssClass).append("\">")
                .append(severity).append("</span></td><td>").append(count).append("</td></tr>\n");
        });
        html.append("</table>\n");
        html.append("</div>\n");
        
        html.append("</div>\n");
        html.append("</div>\n");
        
        return html.toString();
    }
    
    private static String generateDetailedResults(List<PatternExecutionRecord> records) {
        StringBuilder html = new StringBuilder();
        
        html.append("<div class=\"section\">\n");
        html.append("<h2>Detailed Results</h2>\n");
        
        for (PatternExecutionRecord record : records) {
            html.append("<div class=\"execution-card\">\n");
            html.append("<div class=\"execution-header\">\n");
            html.append("<h3>").append(record.getPatternName()).append("</h3>\n");
            html.append("<span class=\"badge badge-").append(record.getSeverity().toLowerCase()).append("\">")
                .append(record.getSeverity()).append("</span>\n");
            html.append("</div>\n");
            
            html.append("<div class=\"execution-details\">\n");
            html.append("<p><strong>Pattern ID:</strong> ").append(record.getPatternId()).append("</p>\n");
            html.append("<p><strong>Category:</strong> ").append(record.getCategory()).append("</p>\n");
            html.append("<p><strong>Target:</strong> ").append(record.getTargetDatabase())
                .append(" (").append(record.getDatabaseType()).append(")</p>\n");
            html.append("<p><strong>Executed:</strong> ").append(record.getExecutionTime().format(DATE_FORMATTER))
                .append(" by ").append(record.getExecutedBy()).append("</p>\n");
            html.append("<p><strong>Duration:</strong> ").append(record.getExecutionDurationMs()).append(" ms</p>\n");
            html.append("<p><strong>Queries:</strong> ").append(record.getTotalQueries())
                .append(" (").append(record.getSuccessfulQueries()).append(" successful, ")
                .append(record.getFailedQueries()).append(" failed)</p>\n");
            html.append("<p><strong>Guardium Alert Expected:</strong> ").append(record.getGuardiumAlertExpected()).append("</p>\n");
            html.append("<p><strong>Guardium Alert Detected:</strong> ")
                .append(record.isGuardiumAlertDetected() ? "Yes" : "No").append("</p>\n");
            html.append("</div>\n");
            
            html.append("</div>\n");
        }
        
        html.append("</div>\n");
        
        return html.toString();
    }
    
    private static String generateRecommendations(List<PatternExecutionRecord> records) {
        StringBuilder html = new StringBuilder();
        
        long failedExecutions = records.stream()
            .filter(r -> r.getFailedQueries() > 0)
            .count();
        
        long missingAlerts = records.stream()
            .filter(r -> !r.isGuardiumAlertDetected())
            .count();
        
        html.append("<div class=\"section\">\n");
        html.append("<h2>Recommendations</h2>\n");
        html.append("<div class=\"recommendations\">\n");
        
        if (failedExecutions > 0) {
            html.append("<div class=\"recommendation warning\">\n");
            html.append("<h4>Failed Query Executions</h4>\n");
            html.append("<p>").append(failedExecutions).append(" pattern execution(s) had failed queries. ")
                .append("Review the detailed results to identify and fix issues.</p>\n");
            html.append("</div>\n");
        }
        
        if (missingAlerts > 0) {
            html.append("<div class=\"recommendation critical\">\n");
            html.append("<h4>Missing Guardium Alerts</h4>\n");
            html.append("<p>").append(missingAlerts).append(" expected Guardium alert(s) were not detected. ")
                .append("Review Guardium policies and ensure monitoring is properly configured.</p>\n");
            html.append("</div>\n");
        }
        
        if (failedExecutions == 0 && missingAlerts == 0) {
            html.append("<div class=\"recommendation success\">\n");
            html.append("<h4>All Tests Passed</h4>\n");
            html.append("<p>All pattern executions completed successfully and expected Guardium alerts were detected. ")
                .append("Security controls are functioning as expected.</p>\n");
            html.append("</div>\n");
        }
        
        html.append("</div>\n");
        html.append("</div>\n");
        
        return html.toString();
    }
    
    private static String getReportStyles() {
        return "body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }\n" +
               ".header { background: #667eea; color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }\n" +
               ".section { background: white; padding: 25px; margin-bottom: 20px; border-radius: 10px; }\n" +
               ".summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }\n" +
               ".summary-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }\n" +
               ".execution-card { background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; }\n" +
               ".badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }\n" +
               ".badge-critical { background-color: #dc3545; color: white; }\n" +
               ".badge-high { background-color: #fd7e14; color: white; }\n" +
               ".badge-medium { background-color: #ffc107; color: black; }\n" +
               ".badge-low { background-color: #28a745; color: white; }\n" +
               ".recommendation { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; }\n" +
               ".recommendation.success { background: #d4edda; border-left-color: #28a745; }\n" +
               ".recommendation.warning { background: #fff3cd; border-left-color: #ffc107; }\n" +
               ".recommendation.critical { background: #f8d7da; border-left-color: #dc3545; }\n" +
               ".footer { text-align: center; padding: 20px; color: #666; }";
    }
    
    private static String escapeCsv(String value) {
        if (value == null) return "";
        if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
            return "\"" + value.replace("\"", "\"\"") + "\"";
        }
        return value;
    }
    
    private static String escapeHtml(String value) {
        if (value == null) return "";
        // Basic HTML escaping
        String result = value;
        result = result.replace("&", "&");
        result = result.replace("<", "<");
        result = result.replace(">", ">");
        return result;
    }
}

